<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON OVERDRIVE: ULTIMATE</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Arial Black', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; user-select: none; }
        #game-container { position: relative; border: 4px solid #111; background: #000; overflow: hidden; box-shadow: 0 0 100px rgba(0, 255, 242, 0.2); width: 400px; height: 700px; }
        canvas { display: block; }
        
        /* UI Top Overlay */
        #ui-top { position: absolute; top: 0; width: 100%; padding: 15px; box-sizing: border-box; display: flex; justify-content: space-between; z-index: 50; pointer-events: none; }
        .stat-box { background: rgba(0,0,0,0.6); padding: 5px 12px; border-left: 3px solid #00fff2; font-size: 12px; letter-spacing: 1px; }
        
        /* Score & Combo */
        #ui-center { position: absolute; top: 80px; width: 100%; text-align: center; pointer-events: none; z-index: 40; }
        #score { font-size: 110px; color: #fff; text-shadow: 0 0 20px #00fff2; margin: 0; font-style: italic; opacity: 0.8; }
        #combo-tag { font-size: 20px; color: #ff0055; text-shadow: 0 0 10px #ff0055; display: none; transform: skewX(-15deg); }

        /* Energy & Timer */
        #ui-bottom { position: absolute; bottom: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        #energy-container { width: 80%; height: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; position: relative; border-radius: 20px; overflow: hidden; }
        #energy-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00fff2, #ff0055); box-shadow: 0 0 20px #00fff2; transition: width 0.1s; }
        #ult-text { position: absolute; width: 100%; text-align: center; font-size: 9px; top: 1px; letter-spacing: 3px; color: #fff; font-weight: bold; display: none; }
        #timer-strip { position: absolute; bottom: 0; width: 100%; height: 5px; background: #ff0055; transition: width 0.1s; box-shadow: 0 -5px 15px #ff0055; }

        /* Menu System */
        #menu { position: absolute; inset: 0; background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%); z-index: 100; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; overflow-y: auto; }
        .logo { font-size: 32px; letter-spacing: 15px; color: #fff; text-shadow: 0 0 20px #00fff2; margin-bottom: 30px; text-align: center; }
        .char-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; margin-bottom: 100px; }
        .char-card { background: #050505; border: 1px solid #222; padding: 15px; cursor: pointer; pointer-events: auto; position: relative; transition: 0.2s; }
        .char-card.selected { border-color: #00fff2; background: rgba(0, 255, 242, 0.05); transform: scale(1.02); }
        .char-card.locked { opacity: 0.5; filter: grayscale(1); }
        .price-tag { position: absolute; top: 10px; right: 10px; color: #ffd700; font-size: 14px; }
        
        #start-btn { position: fixed; bottom: 30px; width: 300px; padding: 20px; background: #fff; color: #000; border: none; cursor: pointer; font-size: 20px; font-weight: bold; letter-spacing: 10px; z-index: 110; pointer-events: auto; box-shadow: 0 0 40px rgba(255,255,255,0.4); }

        /* Death Screen */
        #death-screen { position: absolute; inset: 0; background: #000; z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .glitch { font-size: 50px; color: #fff; text-shadow: 3px 0 #ff0055, -3px 0 #00fff2; animation: glitch-anim 0.1s infinite; }
        .final-stats { margin: 30px 0; text-align: center; font-size: 18px; line-height: 2; color: #aaa; }
        .retry-btn { padding: 15px 50px; background: transparent; border: 2px solid #fff; color: #fff; cursor: pointer; font-family: 'Arial Black'; pointer-events: auto; }

        @keyframes glitch-anim { 0% { transform: translate(2px,0); } 50% { transform: translate(-2px,0); } 100% { transform: translate(0,0); } }
        @keyframes pulse-bg { 0% { background: #000; } 50% { background: #050005; } 100% { background: #000; } }
        .overdrive-active { animation: pulse-bg 0.1s infinite; filter: contrast(1.5) hue-rotate(10deg); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui-top">
        <div class="stat-box" id="best-box">PEAK: <span id="high-score">0</span></div>
        <div class="stat-box" style="border-color:#ffd700">DATA: <span id="coin-count">0</span></div>
    </div>

    <div id="ui-center">
        <div id="score">0</div>
        <div id="combo-tag">X2 COMBO</div>
    </div>

    <div id="ui-bottom">
        <div id="energy-container">
            <div id="energy-bar"></div>
            <div id="ult-text">READY TO OVERDRIVE</div>
        </div>
    </div>
    <div id="timer-strip"></div>

    <div id="menu">
        <div class="logo">NEON<br>OVERDRIVE</div>
        <div class="char-grid" id="char-list">
            </div>
        <button id="start-btn" onclick="startGame()">RUN.EXE</button>
    </div>

    <div id="death-screen">
        <div class="glitch">SYSTEM CRASH</div>
        <div class="final-stats">
            FLOORS CLIMBED: <span id="last-score" style="color:#fff">0</span><br>
            DATA COLLECTED: <span id="session-coins" style="color:#ffd700">0</span><br>
            PEAK ALTITUDE: <span id="last-best" style="color:#00fff2">0</span>
        </div>
        <button class="retry-btn" onclick="location.reload()">REBOOT SYSTEM</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 400; canvas.height = 700;

    // --- GAME STATE ---
    let score, combo, comboTimer, coins, gameOver, stairs, player, timeLeft, cameraY, targetCameraY, lavaY;
    let isPlaying = false, selectedCharId = 'cyber', shake = 0, lives = 1;
    let energy = 0, isUltActive = false, ultTimer = 0, freezeTime = 0;
    let particles = [], stars = [];

    // --- PERSISTENCE ---
    let stats = {
        highScore: parseInt(localStorage.getItem('neonBest')) || 0,
        totalCoins: parseInt(localStorage.getItem('neonCoins')) || 0,
        unlocked: JSON.parse(localStorage.getItem('neonUnlocked')) || ['cyber']
    };

    const CHARS = {
        cyber: { name: 'CYBER-01', color: '#00fff2', price: 0, lore: 'Sync Speed: 69ms. Prototipe asli.', spec: 'ULT: AUTO-CLIMB' },
        gold: { name: 'MIDAS-X', color: '#ffd700', price: 100, lore: 'Efisiensi data tingkat tinggi.', spec: 'ULT: 5X COINS' },
        shadow: { name: 'VOID-WALKER', color: '#ff00ff', price: 250, lore: 'Eksis di sela-sela kode.', spec: 'ULT: FREEZE TIME' },
        phantom: { name: 'GHOST-CORE', color: '#ffffff', price: 500, lore: 'Sistem pertahanan ganda.', spec: 'ULT: INVULNERABLE' }
    };

    function initMenu() {
        const list = document.getElementById('char-list');
        list.innerHTML = '';
        Object.keys(CHARS).forEach(id => {
            const isLocked = !stats.unlocked.includes(id);
            const card = document.createElement('div');
            card.className = `char-card ${id === selectedCharId ? 'selected' : ''} ${isLocked ? 'locked' : ''}`;
            card.innerHTML = `
                <span style="color:${CHARS[id].color}; font-size:18px">${CHARS[id].name}</span>
                <p style="font-size:9px; color:#666; margin:5px 0">${CHARS[id].lore}</p>
                <span style="font-size:10px; color:#ff0055">${CHARS[id].spec}</span>
                ${isLocked ? `<span class="price-tag">ðŸª™ ${CHARS[id].price}</span>` : ''}
            `;
            card.onclick = () => selectChar(id);
            list.appendChild(card);
        });
        document.getElementById('high-score').innerText = stats.highScore;
        document.getElementById('coin-count').innerText = stats.totalCoins;
    }

    function selectChar(id) {
        if (!stats.unlocked.includes(id)) {
            if (stats.totalCoins >= CHARS[id].price) {
                stats.totalCoins -= CHARS[id].price;
                stats.unlocked.push(id);
                saveStats();
                initMenu();
            } else return;
        }
        selectedCharId = id;
        initMenu();
    }

    function saveStats() {
        localStorage.setItem('neonBest', stats.highScore);
        localStorage.setItem('neonCoins', stats.totalCoins);
        localStorage.setItem('neonUnlocked', JSON.stringify(stats.unlocked));
    }

    // --- ENGINE ---
    function initGame() {
        score = 0; combo = 1; comboTimer = 0; coins = 0;
        gameOver = false; timeLeft = 100; energy = 0;
        lavaY = 750; cameraY = 0;
        particles = [];
        lives = (selectedCharId === 'phantom') ? 2 : 1;
        
        stairs = [{ x: 160, y: 550, color: '#fff', type: 'normal' }];
        player = { x: 185, y: 515, w: 25, h: 35, jump: 0, color: CHARS[selectedCharId].color };
        targetCameraY = -player.y + 450;
        
        stars = Array.from({length: 80}, () => ({
            x: Math.random()*400, y: Math.random()*700, 
            s: Math.random()*2, c: '#222'
        }));

        for (let i = 0; i < 30; i++) addStair();
    }

    function addStair() {
        let last = stairs[stairs.length - 1];
        let dir = Math.random() > 0.5 ? 1 : -1;
        let newX = last.x + (dir * 75);
        if (newX < 20 || newX > 300) newX = last.x - (dir * 75);
        
        let roll = Math.random();
        let type = roll > 0.95 ? 'freeze' : roll > 0.85 ? 'coin' : 'normal';
        
        stairs.push({ 
            x: newX, y: last.y - 55, 
            color: `hsl(${(stairs.length * 10) % 360}, 100%, 50%)`,
            type: type
        });
    }

    function move(dir) {
        if (!isPlaying || gameOver) return;
        let next = stairs[score + 1];
        let correctDir = next.x > stairs[score].x ? 1 : -1;

        if (dir === correctDir || (isUltActive && selectedCharId === 'phantom')) {
            score++;
            comboTimer = 60;
            if (comboTimer > 0) combo = Math.min(5, combo + 0.1);

            player.x = next.x + 25;
            player.y = next.y - 35;
            player.jump = 15;
            shake = 5;

            if (next.type === 'coin') {
                let gain = selectedCharId === 'gold' && isUltActive ? 10 : 1;
                coins += gain;
                energy = Math.min(100, energy + 15);
                createParticles(player.x, player.y, "#ffd700", 15);
            } else {
                energy = Math.min(100, energy + 4);
            }

            if (next.type === 'freeze') {
                freezeTime = 200;
                createParticles(player.x, player.y, "#00fff2", 20);
            }

            timeLeft = Math.min(100, timeLeft + 10);
            targetCameraY = -player.y + 450;
            addStair();
            
            document.getElementById('score').innerText = score;
        } else {
            handleDeath();
        }
    }

    function activateUltimate() {
        if (energy < 100 || isUltActive) return;
        energy = 0; isUltActive = true;
        shake = 40;
        document.getElementById('game-container').classList.add('overdrive-active');
        
        if (selectedCharId === 'cyber') ultTimer = 150; // Fast auto climb
        if (selectedCharId === 'gold') ultTimer = 400;  // Long duration 5x coins
        if (selectedCharId === 'shadow') { ultTimer = 300; freezeTime = 300; }
        if (selectedCharId === 'phantom') ultTimer = 300; // Invulnerable
    }

    function handleDeath() {
        if (isUltActive && selectedCharId === 'phantom') return;
        lives--;
        shake = 50;
        createParticles(player.x, player.y, "#ff0055", 50, 15);
        if (lives > 0) {
            lavaY += 300;
            return;
        }

        gameOver = true; isPlaying = false;
        stats.totalCoins += coins;
        if (score > stats.highScore) stats.highScore = score;
        saveStats();

        document.getElementById('death-screen').style.display = 'flex';
        document.getElementById('last-score').innerText = score;
        document.getElementById('session-coins').innerText = coins;
        document.getElementById('last-best').innerText = stats.highScore;
    }

    // --- INPUT ---
    let lastTap = 0;
    canvas.addEventListener('mousedown', (e) => {
        if (!isPlaying || gameOver) return;
        let now = performance.now();
        let threshold = (selectedCharId === 'cyber') ? 69 : 105;

        if (now - lastTap < threshold) {
            activateUltimate();
        } else {
            const rect = canvas.getBoundingClientRect();
            const dir = (e.clientX - rect.left) < canvas.width/2 ? -1 : 1;
            move(dir);
        }
        lastTap = now;
    });

    function createParticles(x, y, color, count, speed) {
        for (let i = 0; i < count; i++) {
            particles.push({
                x, y, vx: (Math.random()-0.5)*speed, vy: (Math.random()-0.5)*speed,
                life: 1, c: color, s: Math.random()*3+1
            });
        }
    }

    function startGame() {
        document.getElementById('menu').style.display = 'none';
        initGame();
        isPlaying = true;
    }

    // --- LOOP ---
    function update() {
        if (!isPlaying || gameOver) return;

        // Combo Logic
        if (comboTimer > 0) {
            comboTimer--;
            document.getElementById('combo-tag').style.display = 'block';
            document.getElementById('combo-tag').innerText = `X${combo.toFixed(1)} COMBO`;
        } else {
            combo = 1;
            document.getElementById('combo-tag').style.display = 'none';
        }

        // Ultimate Logic
        if (isUltActive) {
            ultTimer--;
            if (selectedCharId === 'cyber' && ultTimer % 3 === 0) {
                let next = stairs[score+1];
                move(next.x > stairs[score].x ? 1 : -1);
            }
            if (ultTimer <= 0) {
                isUltActive = false;
                document.getElementById('game-container').classList.remove('overdrive-active');
            }
        }

        // Lava & Time
        if (freezeTime > 0) {
            freezeTime--;
        } else {
            let speed = 1.8 + (score * 0.04);
            lavaY -= speed;
            timeLeft -= 0.5;
        }

        if (timeLeft <= 0 || (player.y + 35) > lavaY) handleDeath();

        // Visuals
        document.getElementById('energy-bar').style.width = energy + "%";
        document.getElementById('ult-text').style.display = energy >= 100 ? 'block' : 'none';
        document.getElementById('timer-strip').style.width = timeLeft + "%";
        
        cameraY += (targetCameraY - cameraY) * 0.15;
        if (shake > 0) shake *= 0.9;

        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.02;
            if (p.life <= 0) particles.splice(i, 1);
        });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (isPlaying) {
            update();

            ctx.save();
            if (shake > 0.5) ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
            ctx.translate(0, cameraY);

            // Background Stars
            stars.forEach(s => {
                ctx.fillStyle = s.c;
                ctx.fillRect(s.x, s.y - (cameraY*0.5) % 700, s.s, s.s);
            });

            // Stairs
            stairs.forEach(s => {
                ctx.shadowBlur = 15; ctx.shadowColor = s.color;
                ctx.fillStyle = s.color;
                ctx.fillRect(s.x, s.y, 80, 8);
                
                if (s.type === 'coin') {
                    ctx.fillStyle = "#ffd700";
                    ctx.beginPath(); ctx.arc(s.x+40, s.y-15, 6, 0, Math.PI*2); ctx.fill();
                } else if (s.type === 'freeze') {
                    ctx.fillStyle = "#00fff2";
                    ctx.fillRect(s.x+32, s.y-25, 15, 15);
                }
            });

            // Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.c;
                ctx.fillRect(p.x, p.y, p.s, p.s);
            });
            ctx.globalAlpha = 1;

            // Lava
            let grad = ctx.createLinearGradient(0, lavaY, 0, lavaY + 400);
            grad.addColorStop(0, freezeTime > 0 ? "rgba(0, 255, 242, 0.8)" : "rgba(255, 0, 85, 0.8)");
            grad.addColorStop(1, "transparent");
            ctx.fillStyle = grad;
            ctx.fillRect(0, lavaY, canvas.width, 500);

            // Player
            ctx.shadowBlur = 25; ctx.shadowColor = player.color;
            ctx.fillStyle = player.color;
            if (selectedCharId === 'phantom' && (isUltActive || lives > 1)) ctx.globalAlpha = 0.4;
            let j = player.jump; if (player.jump > 0) player.jump *= 0.8;
            ctx.fillRect(player.x - j/2, player.y - j, player.w + j, player.h + j);
            
            ctx.restore();
        }
        requestAnimationFrame(draw);
    }

    initMenu();
    draw();
</script>
</body>
</html>
